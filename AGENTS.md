# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Essential Commands

### Development

- `pnpm run server:d` - Start React dev server via Craco (port configured by `scripts/dev-config.js`)
- `pnpm run build:d` - Concurrent Relay watch + React dev server
- `pnpm run wsproxy` - Start websocket proxy (required for local development)

### Build and Production

- `pnpm run build` - Full production build (cleans `build/web/`, copies resources, builds React via Craco with Workbox service worker generation, builds workspace packages)
- `pnpm run build:react-only` - Build only React app via Craco
- `pnpm run relay` - Compile GraphQL queries with Relay compiler

### Quality Control

- `pnpm run lint` - Run ESLint (exits with 0 to not break builds)
- `pnpm run lint-fix` - Auto-fix ESLint issues
- `pnpm run format` - Check code formatting with Prettier
- `pnpm run format-fix` - Auto-fix code formatting

### Testing

- `pnpm run test` - Run Jest tests (root: `scripts/`, `src/`)
- `pnpm run test` (in `/react` directory) - Run React-specific Jest tests
- E2E tests (`/e2e/`) use Playwright; require full Backend.AI cluster running first

### Electron App

- `pnpm run electron:d` - Run Electron app in development mode
- `make clean && make dep` - Prepare dependencies for Electron
- `make mac` / `make win` / `make linux` - Build platform-specific apps

## Architecture Overview

### Architecture

This is a **React web application** using React 19 + Ant Design 6 + Relay 20 (GraphQL).

### Key Technologies

- **React Build**: Webpack via @craco/craco (Create React App with customizations)
- **Component Library Build**: Vite (`packages/backend.ai-ui/`)
- **Service Worker**: workbox-webpack-plugin (GenerateSW, integrated into Craco/Webpack build)
- **Package Manager**: pnpm with workspace monorepo
- **Styling**: Ant Design + antd-style
- **State Management**: Jotai (global UI state), Relay (server/GraphQL state)
- **GraphQL**: Relay compiler with projects for both `react/` and `packages/backend.ai-ui/`
- **React Compiler**: babel-plugin-react-compiler in annotation mode (`'use memo'` directive)
- **Testing**: Jest for unit tests, Playwright for E2E tests
- **Linting**: ESLint 9 (flat config) + Prettier, pre-commit hooks via Husky + lint-staged
- **Electron**: Desktop app wrapper with built-in websocket proxy
- **Storybook**: @storybook/react-vite for `backend.ai-ui` component library

### Project Structure

```
react/                  # Main React application (Webpack/Craco)
  src/                  # Application source code
    components/         # React UI components
    pages/              # Page-level components
    hooks/              # Custom React hooks
    helper/             # Utility functions
    __generated__/      # Relay compiler output
  craco.config.cjs      # Webpack customization via Craco
packages/               # Monorepo workspace packages
  backend.ai-ui/        # Shared React component library (Vite build)
  backend.ai-webui-docs/# User manual documentation
  eslint-config-bai/    # Shared ESLint configuration
src/                    # Utilities and websocket proxy
  lib/                  # Backend.AI client library (ESM/Node.js)
  wsproxy/              # WebSocket proxy for desktop app
resources/              # Static assets, i18n files (22 languages), themes
data/                   # GraphQL schema files (schema.graphql, client-directives.graphql)
e2e/                    # Playwright E2E tests
electron-app/           # Electron desktop app source
configs/                # Environment-specific config files
scripts/                # Build and dev utility scripts
```

### Build Pipeline

Production build (`pnpm run build`) runs these steps sequentially:
1. Clean and create `build/web/` output directory
2. Copy `index.html`, `resources/`, `manifest/`, config files
3. `pnpm run -r --stream build` builds all workspace packages:
   - React app (Craco/Webpack) → `react/build/` → copied to `build/web/`
   - Service worker (`sw.js`) generated by workbox-webpack-plugin during React build
   - backend.ai-ui (Vite) → `packages/backend.ai-ui/dist/`

### Development Workflow

1. **Dual Server Setup**: Run both `pnpm run server:d` (React dev server) and `pnpm run wsproxy` (WebSocket proxy) for full development
2. **Alternative**: `pnpm run build:d` runs Relay watch + React dev server concurrently
3. **Port Configuration**: Managed by `scripts/dev-config.js` (default React port: 9081)
4. **Testing**: Jest unit tests + Playwright E2E tests
5. **Linting**: ESLint 9 (flat config) + Prettier with pre-commit hooks via Husky

# Additional Workflow Description

- All work items are created in Jira and serve as the starting point for understanding and resolving tasks.
- Work items are cloned as GitHub issues in the corresponding repository.
- GitHub PR titles follow this format:

  - prefix
    - feat: New features or feature improvements and changes
    - fix: Bug fixes
    - refactor: Refactoring
    - style: Design changes without functional changes
    - chore: Other small tasks
  - Format: `prefix(JIRA-ISSUE-NUMBER): title`
  - GitHub PR content starts with `Resolves #1234(FR-1234)` where #1234 is the cloned issue number and FR-1234 is the Jira issue number

- **CRITICAL - MCP Tool Requirements (No CLI alternatives)**:
  - **Jira**: Use Atlassian MCP (`mcp__Atlassian__*`) for ALL operations
    - `mcp__Atlassian__searchJiraIssuesUsingJql` - Search/query issues
    - `mcp__Atlassian__getJiraIssue` - Get issue details
    - `mcp__Atlassian__createJiraIssue` - Create issues
    - `mcp__Atlassian__editJiraIssue` - Update issues
  - **GitHub**: Use GitHub MCP (`mcp__github__*`) or `gh` CLI
    - `mcp__github__search_issues` - Search issues
    - `mcp__github__issue_read` - Get issue details
  - **Git/PR**: Use Graphite MCP (`mcp__graphite__run_gt_cmd`) for branch/commit/push
    - Do NOT use `git commit`, `git push`, `git checkout -b` directly
    - Allowed: `git status`, `git diff`, `git add`, `git log`, `git stash`
- If MCP authentication fails, re-authenticate and retry before proceeding.
- Follow Graphite's Stacked PR strategy. Write work by appropriately stacking individual PRs.

### Configuration

- Main config: `config.toml` (copied from `config.toml.sample`)
- Multiple environments supported via `configs/` directory
- Electron app config: `build/electron-app/app/config.toml`

### Key Libraries

- **react** 19, **react-dom** 19 - UI framework
- **antd** 6 - Ant Design component library
- **react-relay** 20, **relay-runtime** 20 - GraphQL client
- **jotai** - Atomic state management
- **i18next**, **react-i18next** - Internationalization
- **@craco/craco** - CRA webpack customization
- **electron** 35 - Desktop app framework

### GraphQL/Relay Setup

- Schema files in `/data/` (`schema.graphql`, `client-directives.graphql`)
- Relay compiler configured for two projects: `react` and `backend.ai-ui`
- Config: `/relay.config.js` (extends `/relay-base.config.js`)
- Generated types output to `react/src/__generated__/` and `packages/backend.ai-ui/src/__generated__/`
- Run `pnpm run relay` to compile GraphQL queries
- Run `pnpm run relay:watch` for watch mode during development

### Internationalization

- JSON translation files in `resources/i18n/` (22 languages supported)
- React components use `useTranslation()` hook from `react-i18next`
- Backend.AI UI package has own locale files in `packages/backend.ai-ui/src/locale/`
- Run `make i18n` to extract translation strings

### Build Output

- Production build: `build/web/` (contains React build + service worker + static assets)
- Electron app: `build/electron-app/` (created by `make dep`)
- Component library: `packages/backend.ai-ui/dist/`

## Important Notes

- Always run websocket proxy (`pnpm run wsproxy`) for local development
- Pre-commit hooks (Husky + lint-staged) run linting and formatting automatically
- Use `make clean` before building if encountering issues
- Electron app requires special build process with `make dep`
- React components use Relay; ensure GraphQL schema in `/data/` is up to date
- Backend.AI client library (`src/lib/backend.ai-client-esm.ts`) is aliased in Craco config

## GitHub Copilot Custom Instructions

This repository includes custom instructions for GitHub Copilot to provide more accurate code reviews and suggestions. These instructions are automatically applied when using GitHub Copilot on github.com, VS Code, and Visual Studio. When writing new code or refactoring, please make sure to refer to these instructions.

### Instruction Files

Custom instructions are located in the `.github/` directory:

- **`.github/copilot-instructions.md`** - Repository-wide guidelines

  - General code review principles
  - Security best practices (OWASP Top 10)
  - TypeScript conventions
  - Architecture awareness (React application)
  - Git workflow and commit message format
  - Testing and performance guidelines

- **`.github/instructions/react.instructions.md`** - React component guidelines

  - React Compiler optimization (`'use memo'` directive)
  - React composability principles
  - GraphQL/Relay patterns (`useLazyLoadQuery`, `useFragment`, `useRefetchableFragment`)
  - Backend.AI UI component library (`BAI*` components preferred over Ant Design)
  - Custom utilities (`useFetchKey`, `BAIUnmountAfterClose`)
  - Error boundaries (`ErrorBoundaryWithNullFallback`, `BAIErrorBoundary`)
  - Jotai for global state management
  - Ant Design usage patterns (prefer `App.useApp()` for modals)

- **`.github/instructions/i18n.instructions.md`** - Internationalization guidelines
  - Translation key naming conventions
    - Main WebUI: `category.key` format
    - Backend.AI UI package: `comp:ComponentName.key` format
  - Placeholder preservation
  - Language-specific guidelines (Korean, Japanese, Chinese)
  - Backend.AI platform context awareness

- **`.github/instructions/storybook.instructions.md`** - Storybook story guidelines
  - CSF 3 format with TypeScript
  - Meta configuration (title, tags, parameters, argTypes)
  - Story patterns (args-based, render function, Relay fragment)
  - Documentation best practices
  - Story organization and naming conventions
  - Complete templates and checklists

### How It Works

- GitHub Copilot automatically applies these instructions when working in this repository
- Instructions use path-based targeting with `applyTo` frontmatter:
  - React instructions apply to `react/**/*.tsx` and `react/**/*.ts`
  - i18n instructions apply to translation JSON files and all TypeScript/TSX files
- The instructions help Copilot provide more contextually relevant suggestions and code reviews

### Key Guidelines for AI Assistants

When reviewing or writing code:

1. **React Components**: Always prefer `'use memo'` directive over manual `useMemo`/`useCallback`
2. **UI Components**: Use `BAI*` components from `backend.ai-ui` package instead of Ant Design equivalents
3. **i18n**: Never hard-code user-facing text; always use translation functions with proper key formats
4. **Composability**: Check for proper component composition, avoid props drilling
5. **Custom Hooks**: Verify `useFetchKey` and `BAIUnmountAfterClose` are used where appropriate
6. **Error Handling**: Use pre-defined error boundaries instead of creating new ones
7. **Storybook Stories**: Follow CSF 3 format, include `tags: ['autodocs']`, document with argTypes and descriptions

## Other guidelines

Read and follow below guides:

- @guides-for-ai/react-component-guide.md
- @.github/copilot-instructions.md
- @.github/instructions/react.instructions.md
- @.github/instructions/i18n.instructions.md
- @.github/instructions/storybook.instructions.md
- @.github/instructions/docs.instructions.md
